<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Aplikasi Bank Sampah SMAN 2 Trenggalek - Powered by Adiwiyata Bakti Mandala">
    <title>Bank Sampah SMAN 2 Trenggalek</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸŒ±</text></svg>">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // Icons
        const Download = ({size = 24}) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>
            </svg>
        );
        
        const Plus = ({size = 24}) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
        );
        
        const Settings = ({size = 24}) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="12" cy="12" r="3"/>
                <path d="M12 1v6m0 6v6m-9-9h6m6 0h6"/>
            </svg>
        );
        
        const BarChart3 = ({size = 24}) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M3 3v18h18M18 17V9m-5 8V5m-5 12v-4"/>
            </svg>
        );
        
        const Trash2 = ({size = 24}) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="3 6 5 6 21 6"/>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
            </svg>
        );
        
        const Save = ({size = 24}) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                <polyline points="17 21 17 13 7 13 7 21"/>
            </svg>
        );

        const Ticket = ({size = 24}) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/>
                <path d="M13 5v2m0 4v2m0 4v2"/>
            </svg>
        );

        const Moon = ({size = 24}) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
            </svg>
        );

        const Sun = ({size = 24}) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="12" cy="12" r="4"/>
                <path d="M12 2v2m0 16v2M4.93 4.93l1.41 1.41m11.32 11.32l1.41 1.41M2 12h2m16 0h2M4.93 19.07l1.41-1.41m11.32-11.32l1.41-1.41"/>
            </svg>
        );

        const Upload = ({size = 24}) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4m14-7l-5-5-5 5m5-5v12"/>
            </svg>
        );

        // Toast Component
        const Toast = ({ message, type = 'info', onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, [onClose]);

            const bgColor = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500',
                warning: 'bg-yellow-500'
            }[type];

            return (
                <div className={`fixed top-4 right-4 z-50 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg flex items-center space-x-3 animate-slide-in`}>
                    <span>{message}</span>
                    <button onClick={onClose} className="ml-4 text-white hover:text-gray-200">Ã—</button>
                </div>
            );
        };

        // Storage polyfill
        window.storage = {
            get: async (key) => {
                try {
                    const value = localStorage.getItem(key);
                    return value ? { key, value, shared: false } : null;
                } catch (error) {
                    return null;
                }
            },
            set: async (key, value) => {
                try {
                    localStorage.setItem(key, value);
                    return { key, value, shared: false };
                } catch (error) {
                    return null;
                }
            },
            delete: async (key) => {
                try {
                    localStorage.removeItem(key);
                    return { key, deleted: true, shared: false };
                } catch (error) {
                    return null;
                }
            }
        };

        // Main App
        const BankSampahApp = () => {
          const [activeTab, setActiveTab] = useState('input');
          const [transactions, setTransactions] = useState([]);
          const [wasteTypes, setWasteTypes] = useState(['Plastik', 'Kertas', 'Botol', 'Kaleng', 'Kardus']);
          const [priceSettings, setPriceSettings] = useState({});
          const [modePisahJenis, setModePisahJenis] = useState(true);
          const [hargaAkumulasi, setHargaAkumulasi] = useState(2000);
          const [beratPerKupon, setBeratPerKupon] = useState(0.5);
          const [coupons, setCoupons] = useState([]);
          const [darkMode, setDarkMode] = useState(false);
          const [toast, setToast] = useState(null);
          const [filterPeriod, setFilterPeriod] = useState('all');
          const [customDateStart, setCustomDateStart] = useState('');
          const [customDateEnd, setCustomDateEnd] = useState('');
          const [selectedWasteTypes, setSelectedWasteTypes] = useState({});
          const [beratPerJenis, setBeratPerJenis] = useState({});
          const [nomorKuponList, setNomorKuponList] = useState([]);
          const [showKuponInput, setShowKuponInput] = useState(false);
          const [kuponPage, setKuponPage] = useState(0);
          const [editingKupon, setEditingKupon] = useState(null);
          const [editNomorValue, setEditNomorValue] = useState('');
          const KUPON_PER_PAGE = 25;
          const [formData, setFormData] = useState({
            kelas: 'X1',
            koordinator: '',
            petugas: '',
            catatan: ''
          });
          const chartRef = useRef(null);
          const chartInstance = useRef(null);

          const kelasOptions = [
            'X1', 'X2', 'X3', 'X4', 'X5', 'X6', 'X7', 'X8', 'X9',
            'XI A', 'XI B', 'XI C', 'XI D', 'XI E', 'XI F', 'XI G', 'XI H', 'XI I',
            'XII A', 'XII B', 'XII C', 'XII D', 'XII E', 'XII F', 'XII G', 'XII H', 'XII I'
          ];

          useEffect(() => {
            loadData();
          }, []);

          useEffect(() => {
            document.body.className = darkMode ? 'bg-gray-900' : 'bg-gradient-to-br from-green-50 to-blue-50';
          }, [darkMode]);

          useEffect(() => {
            const initialPrices = {};
            wasteTypes.forEach(type => {
              if (!priceSettings[type]) {
                initialPrices[type] = 2000;
              }
            });
            if (Object.keys(initialPrices).length > 0) {
              setPriceSettings(prev => ({ ...prev, ...initialPrices }));
            }
          }, [wasteTypes]);

          const showToast = (message, type = 'info') => {
            setToast({ message, type });
          };

          const loadData = async () => {
            try {
              const txResult = await window.storage.get('transactions');
              const wtResult = await window.storage.get('wasteTypes');
              const priceResult = await window.storage.get('prices');
              const modeResult = await window.storage.get('modePisahJenis');
              const hargaAkumResult = await window.storage.get('hargaAkumulasi');
              const beratKuponResult = await window.storage.get('beratPerKupon');
              const couponsResult = await window.storage.get('coupons');
              const darkModeResult = await window.storage.get('darkMode');
              
              if (txResult) setTransactions(JSON.parse(txResult.value));
              if (wtResult) setWasteTypes(JSON.parse(wtResult.value));
              if (priceResult) setPriceSettings(JSON.parse(priceResult.value));
              if (modeResult) setModePisahJenis(JSON.parse(modeResult.value));
              if (hargaAkumResult) setHargaAkumulasi(JSON.parse(hargaAkumResult.value));
              if (beratKuponResult) setBeratPerKupon(JSON.parse(beratKuponResult.value));
              if (couponsResult) setCoupons(JSON.parse(couponsResult.value));
              if (darkModeResult) setDarkMode(JSON.parse(darkModeResult.value));
            } catch (error) {
              console.log('Loading initial data');
            }
          };

          const saveData = async () => {
            try {
              await window.storage.set('transactions', JSON.stringify(transactions));
              await window.storage.set('wasteTypes', JSON.stringify(wasteTypes));
              await window.storage.set('prices', JSON.stringify(priceSettings));
              await window.storage.set('modePisahJenis', JSON.stringify(modePisahJenis));
              await window.storage.set('hargaAkumulasi', JSON.stringify(hargaAkumulasi));
              await window.storage.set('beratPerKupon', JSON.stringify(beratPerKupon));
              await window.storage.set('coupons', JSON.stringify(coupons));
              await window.storage.set('darkMode', JSON.stringify(darkMode));
            } catch (error) {
              console.error('Error saving:', error);
            }
          };

          useEffect(() => {
            saveData();
          }, [transactions, wasteTypes, priceSettings, modePisahJenis, hargaAkumulasi, beratPerKupon, coupons, darkMode]);

          const handleInputChange = (e) => {
            const { name, value } = e.target;
            setFormData(prev => ({ ...prev, [name]: value }));
          };

          const toggleWasteType = (type) => {
            setSelectedWasteTypes(prev => {
              const newSelected = { ...prev, [type]: !prev[type] };
              // Reset berat jika di-nonaktifkan
              if (!newSelected[type]) {
                const newBerat = { ...beratPerJenis };
                delete newBerat[type];
                setBeratPerJenis(newBerat);
              }
              return newSelected;
            });
          };

          const handleBeratJenisChange = (type, value) => {
            setBeratPerJenis(prev => ({
              ...prev,
              [type]: parseFloat(value) || 0
            }));
          };

          const getTotalBerat = () => {
            if (modePisahJenis) {
              return Object.values(beratPerJenis).reduce((a, b) => a + b, 0);
            } else {
              return parseFloat(document.getElementById('beratAkumulasi')?.value || 0);
            }
          };

          const getJumlahKupon = () => {
            const totalBerat = getTotalBerat();
            return Math.floor(totalBerat / beratPerKupon);
          };

          const handleNomorKuponChange = (index, value) => {
            const newList = [...nomorKuponList];
            newList[index] = value;
            setNomorKuponList(newList);
          };

          const toggleKuponInput = () => {
            const jumlah = getJumlahKupon();
            if (jumlah > 0) {
              if (!showKuponInput) {
                setNomorKuponList(Array(jumlah).fill(''));
              }
              setShowKuponInput(!showKuponInput);
            } else {
              showToast('Berat belum cukup untuk kupon', 'warning');
            }
          };

          const generateKodeUnik = () => {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
              result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
          };

          const generateNomorKupon = () => {
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0].replace(/-/g, '');
            return `BSDA-RNDM-${dateStr}-${generateKodeUnik()}`;
          };

          const handleSubmit = () => {
            if (!formData.petugas || !formData.koordinator) {
              showToast('Mohon lengkapi semua field!', 'error');
              return;
            }

            const selectedTypes = Object.entries(selectedWasteTypes)
              .filter(([_, selected]) => selected)
              .map(([type]) => type);

            let totalBerat = 0;
            const newTransactions = [];
            const setoranId = `SET-${Date.now()}-${generateKodeUnik()}`;

            if (modePisahJenis) {
              if (selectedTypes.length === 0) {
                showToast('Pilih minimal 1 jenis sampah!', 'error');
                return;
              }

              for (const type of selectedTypes) {
                if (!beratPerJenis[type] || beratPerJenis[type] <= 0) {
                  showToast(`Masukkan berat untuk ${type}!`, 'error');
                  return;
                }
              }

              selectedTypes.forEach(jenis => {
                const berat = beratPerJenis[jenis];
                totalBerat += berat;
                const hargaPerKg = priceSettings[jenis] || 2000;
                const totalHarga = berat * hargaPerKg;
                
                newTransactions.push({
                  id: Date.now() + Math.random(),
                  setoranId: setoranId,
                  kelas: formData.kelas,
                  koordinator: formData.koordinator,
                  jenisSampah: jenis,
                  berat: berat,
                  hargaPerKg: hargaPerKg,
                  totalHarga: totalHarga,
                  tanggal: new Date().toISOString(),
                  petugas: formData.petugas,
                  catatan: formData.catatan || ''
                });
              });
            } else {
              const beratAkumulasi = parseFloat(document.getElementById('beratAkumulasi')?.value || 0);
              if (!beratAkumulasi || beratAkumulasi <= 0) {
                showToast('Masukkan berat sampah!', 'error');
                return;
              }

              totalBerat = beratAkumulasi;
              const totalHarga = beratAkumulasi * hargaAkumulasi;
              
              newTransactions.push({
                id: Date.now(),
                setoranId: setoranId,
                kelas: formData.kelas,
                koordinator: formData.koordinator,
                jenisSampah: 'Akumulasi',
                berat: beratAkumulasi,
                hargaPerKg: hargaAkumulasi,
                totalHarga: totalHarga,
                tanggal: new Date().toISOString(),
                petugas: formData.petugas,
                catatan: formData.catatan || ''
              });
            }

            const jumlahKupon = Math.floor(totalBerat / beratPerKupon);
            const newCoupons = [];
            
            if (jumlahKupon > 0) {
              const nomorTerisi = nomorKuponList.filter(n => n && n.trim());
              
              if (nomorTerisi.length > 0) {
                nomorTerisi.forEach((nomor, idx) => {
                  newCoupons.push({
                    id: `KPN-${Date.now()}-${idx}-${generateKodeUnik()}`,
                    nomor: nomor.trim(),
                    setoranId: setoranId,
                    kelas: formData.kelas,
                    koordinator: formData.koordinator,
                    berat: totalBerat,
                    jumlahTotal: jumlahKupon,
                    urutanKe: idx + 1,
                    tanggal: new Date().toISOString(),
                    digunakan: false
                  });
                });
              } else {
                for (let i = 0; i < jumlahKupon; i++) {
                  newCoupons.push({
                    id: `KPN-${Date.now()}-${i}-${generateKodeUnik()}`,
                    nomor: generateNomorKupon(),
                    setoranId: setoranId,
                    kelas: formData.kelas,
                    koordinator: formData.koordinator,
                    berat: totalBerat,
                    jumlahTotal: jumlahKupon,
                    urutanKe: i + 1,
                    tanggal: new Date().toISOString(),
                    digunakan: false
                  });
                }
              }
            }

            setTransactions(prev => [...newTransactions, ...prev]);
            if (newCoupons.length > 0) {
              setCoupons(prev => [...newCoupons, ...prev]);
            }
            
            setFormData({ kelas: 'X1', koordinator: '', petugas: '', catatan: '' });
            setSelectedWasteTypes({});
            setBeratPerJenis({});
            setNomorKuponList([]);
            setShowKuponInput(false);
            
            const kuponMsg = jumlahKupon > 0 ? ` Diterbitkan ${jumlahKupon} kupon.` : ' Berat belum cukup untuk kupon.';
            showToast(`Data berhasil ditambahkan!${kuponMsg}`, 'success');
          };

          const handleDeleteTransaction = (id) => {
            setTransactions(prev => prev.filter(t => t.id !== id));
            showToast('Data berhasil dihapus', 'success');
          };

          const handleDeleteKupon = (id) => {
            if (confirm('Yakin ingin menghapus kupon ini?')) {
              setCoupons(prev => prev.filter(c => c.id !== id));
              showToast('Kupon berhasil dihapus', 'success');
            }
          };

          const handleEditKupon = (kupon) => {
            setEditingKupon(kupon.id);
            setEditNomorValue(kupon.nomor);
          };

          const handleSaveEditKupon = () => {
            if (!editNomorValue.trim()) {
              showToast('Nomor kupon tidak boleh kosong', 'error');
              return;
            }
            setCoupons(prev => prev.map(c => 
              c.id === editingKupon ? { ...c, nomor: editNomorValue.trim() } : c
            ));
            setEditingKupon(null);
            setEditNomorValue('');
            showToast('Nomor kupon berhasil diubah', 'success');
          };

          const handleCancelEditKupon = () => {
            setEditingKupon(null);
            setEditNomorValue('');
          };

          const getKuponPerKelas = () => {
            const perKelas = {};
            coupons.forEach(c => {
              if (!perKelas[c.kelas]) {
                perKelas[c.kelas] = { tersedia: 0, digunakan: 0, total: 0 };
              }
              perKelas[c.kelas].total += 1;
              if (c.digunakan) {
                perKelas[c.kelas].digunakan += 1;
              } else {
                perKelas[c.kelas].tersedia += 1;
              }
            });
            return perKelas;
          };

          const addWasteType = () => {
            const newType = prompt('Masukkan nama jenis sampah baru:');
            if (newType && !wasteTypes.includes(newType)) {
              setWasteTypes(prev => [...prev, newType]);
              setPriceSettings(prev => ({ ...prev, [newType]: 2000 }));
              showToast(`Jenis sampah "${newType}" berhasil ditambahkan`, 'success');
            }
          };

          const deleteWasteType = (type) => {
            if (wasteTypes.length <= 1) {
              showToast('Minimal harus ada 1 jenis sampah', 'error');
              return;
            }
            setWasteTypes(prev => prev.filter(t => t !== type));
            const newPrices = { ...priceSettings };
            delete newPrices[type];
            setPriceSettings(newPrices);
            showToast(`Jenis sampah "${type}" berhasil dihapus`, 'success');
          };

          const getFilteredTransactions = () => {
            return transactions.filter(t => {
              const txDate = new Date(t.tanggal);
              const now = new Date();
              
              if (filterPeriod === 'custom' && customDateStart && customDateEnd) {
                const start = new Date(customDateStart);
                const end = new Date(customDateEnd);
                end.setHours(23, 59, 59);
                return txDate >= start && txDate <= end;
              }
              
              switch(filterPeriod) {
                case 'today':
                  return txDate.toDateString() === now.toDateString();
                case 'week':
                  const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                  return txDate >= weekAgo;
                case 'month':
                  return txDate.getMonth() === now.getMonth() && txDate.getFullYear() === now.getFullYear();
                default:
                  return true;
              }
            });
          };

          const getSummary = () => {
            const filtered = getFilteredTransactions();
            const totalBerat = filtered.reduce((sum, t) => sum + t.berat, 0);
            const totalNilai = filtered.reduce((sum, t) => sum + t.totalHarga, 0);
            
            const perKelas = {};
            const perJenis = {};
            
            filtered.forEach(t => {
              if (!perKelas[t.kelas]) perKelas[t.kelas] = { berat: 0, nilai: 0, count: 0 };
              perKelas[t.kelas].berat += t.berat;
              perKelas[t.kelas].nilai += t.totalHarga;
              perKelas[t.kelas].count += 1;
              
              if (!perJenis[t.jenisSampah]) perJenis[t.jenisSampah] = { berat: 0, nilai: 0, count: 0 };
              perJenis[t.jenisSampah].berat += t.berat;
              perJenis[t.jenisSampah].nilai += t.totalHarga;
              perJenis[t.jenisSampah].count += 1;
            });
            
            const jenisTerbanyak = Object.entries(perJenis)
              .sort((a, b) => b[1].berat - a[1].berat)[0];
            
            return { totalBerat, totalNilai, perKelas, perJenis, jenisTerbanyak };
          };

          const exportToCSV = () => {
            const filtered = getFilteredTransactions();
            let csv = 'Tanggal,Kelas,Koordinator,Jenis Sampah,Berat (kg),Harga per Kg,Total Harga,Petugas,Catatan\n';
            
            filtered.forEach(t => {
              const tanggal = new Date(t.tanggal).toLocaleString('id-ID');
              const catatan = (t.catatan || '').replace(/"/g, '""');
              csv += `"${tanggal}","${t.kelas}","${t.koordinator}","${t.jenisSampah}",${t.berat},${t.hargaPerKg},${t.totalHarga},"${t.petugas}","${catatan}"\n`;
            });
            
            const summary = getSummary();
            csv += '\n\nRINGKASAN\n';
            csv += `Total Berat,${summary.totalBerat.toFixed(2)} kg\n`;
            csv += `Total Nilai,Rp ${summary.totalNilai.toLocaleString('id-ID')}\n`;
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `bank-sampah-${Date.now()}.csv`;
            link.click();
            showToast('Data berhasil diekspor ke CSV', 'success');
          };

          const exportConfig = () => {
            const config = {
              wasteTypes,
              priceSettings,
              modePisahJenis,
              hargaAkumulasi,
              beratPerKupon,
              darkMode,
              version: '2.0'
            };
            
            const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `config-${Date.now()}.json`;
            link.click();
            showToast('Konfigurasi berhasil diekspor', 'success');
          };

          const exportAllData = () => {
            const allData = {
              transactions,
              coupons,
              wasteTypes,
              priceSettings,
              modePisahJenis,
              hargaAkumulasi,
              beratPerKupon,
              darkMode,
              exportDate: new Date().toISOString(),
              version: '2.0'
            };
            
            const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `bank-sampah-backup-${Date.now()}.json`;
            link.click();
            showToast('Semua data berhasil diekspor', 'success');
          };

          const importAllData = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
              try {
                const data = JSON.parse(e.target.result);
                
                // Import semua data
                if (data.transactions) setTransactions(data.transactions);
                if (data.coupons) setCoupons(data.coupons);
                if (data.wasteTypes) setWasteTypes(data.wasteTypes);
                if (data.priceSettings) setPriceSettings(data.priceSettings);
                if (data.modePisahJenis !== undefined) setModePisahJenis(data.modePisahJenis);
                if (data.hargaAkumulasi) setHargaAkumulasi(data.hargaAkumulasi);
                if (data.beratPerKupon) setBeratPerKupon(data.beratPerKupon);
                if (data.darkMode !== undefined) setDarkMode(data.darkMode);
                
                showToast('Semua data berhasil diimpor', 'success');
              } catch (error) {
                showToast('File backup tidak valid', 'error');
              }
            };
            reader.readAsText(file);
            event.target.value = '';
          };

          const resetAllData = () => {
            const confirmed = confirm(
              'âš ï¸ PERINGATAN!\n\n' +
              'Apakah Anda yakin ingin menghapus SEMUA DATA?\n\n' +
              'Ini akan menghapus:\n' +
              '- Semua transaksi\n' +
              '- Semua kupon\n' +
              '- Pengaturan custom\n\n' +
              'Data yang dihapus TIDAK DAPAT dikembalikan!\n\n' +
              'Ketik "RESET" di prompt berikutnya untuk konfirmasi.'
            );
            
            if (!confirmed) return;
            
            const confirmation = prompt('Ketik "RESET" (huruf besar) untuk menghapus semua data:');
            
            if (confirmation === 'RESET') {
              // Reset ke default
              setTransactions([]);
              setCoupons([]);
              setWasteTypes(['Plastik', 'Kertas', 'Botol', 'Kaleng', 'Kardus']);
              setPriceSettings({
                'Plastik': 2000,
                'Kertas': 1500,
                'Botol': 3000,
                'Kaleng': 4000,
                'Kardus': 1000
              });
              setModePisahJenis(true);
              setHargaAkumulasi(2000);
              setBeratPerKupon(0.5);
              setDarkMode(false);
              setSelectedWasteTypes({});
              setBeratPerJenis({});
              setNomorKuponList([]);
              setShowKuponInput(false);
              setFormData({ kelas: 'X1', koordinator: '', petugas: '', catatan: '' });
              setFilterPeriod('all');
              setCustomDateStart('');
              setCustomDateEnd('');
              
              // Clear localStorage
              localStorage.clear();
              
              showToast('Semua data berhasil dihapus. Sistem dikembalikan ke default.', 'success');
            } else {
              showToast('Reset dibatalkan. Ketik "RESET" dengan huruf besar untuk konfirmasi.', 'warning');
            }
          };

          const importConfig = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
              try {
                const config = JSON.parse(e.target.result);
                if (config.wasteTypes) setWasteTypes(config.wasteTypes);
                if (config.priceSettings) setPriceSettings(config.priceSettings);
                if (config.modePisahJenis !== undefined) setModePisahJenis(config.modePisahJenis);
                if (config.hargaAkumulasi) setHargaAkumulasi(config.hargaAkumulasi);
                if (config.beratPerKupon) setBeratPerKupon(config.beratPerKupon);
                if (config.darkMode !== undefined) setDarkMode(config.darkMode);
                showToast('Konfigurasi berhasil diimpor', 'success');
              } catch (error) {
                showToast('File konfigurasi tidak valid', 'error');
              }
            };
            reader.readAsText(file);
          };

          const useCoupon = () => {
            const nomor = prompt('Masukkan nomor kupon:');
            if (!nomor) return;
            
            const coupon = coupons.find(c => c.nomor === nomor.trim() && !c.digunakan);
            if (coupon) {
              setCoupons(prev => prev.map(c => 
                c.id === coupon.id ? { ...c, digunakan: true, tanggalDigunakan: new Date().toISOString() } : c
              ));
              showToast(`Kupon ${nomor} berhasil digunakan!`, 'success');
            } else {
              showToast('Kupon tidak valid atau sudah digunakan', 'error');
            }
          };

          const paginatedCoupons = coupons.slice(
            kuponPage * KUPON_PER_PAGE,
            (kuponPage + 1) * KUPON_PER_PAGE
          );
          const totalKuponPages = Math.ceil(coupons.length / KUPON_PER_PAGE);
          const kuponPerKelas = getKuponPerKelas();

          const summary = getSummary();
          const filteredTransactions = getFilteredTransactions();
          const totalKupon = coupons.length;
          const kuponDigunakan = coupons.filter(c => c.digunakan).length;
          const kuponSisa = totalKupon - kuponDigunakan;

          const bgClass = darkMode ? 'bg-gray-800' : 'bg-white';
          const textClass = darkMode ? 'text-white' : 'text-gray-800';
          const borderClass = darkMode ? 'border-gray-700' : 'border-gray-300';

          return (
            <div className={`min-h-screen ${darkMode ? 'bg-gray-900' : 'bg-gradient-to-br from-green-50 to-blue-50'}`}>
              <style>{`
                @keyframes slide-in {
                  from { transform: translateX(100%); opacity: 0; }
                  to { transform: translateX(0); opacity: 1; }
                }
                .animate-slide-in { animation: slide-in 0.3s ease-out; }
              `}</style>

              {toast && (
                <Toast
                  message={toast.message}
                  type={toast.type}
                  onClose={() => setToast(null)}
                />
              )}

              <div className="bg-green-600 text-white p-6 shadow-lg">
                <div className="max-w-7xl mx-auto flex justify-between items-center">
                  <div>
                    <h1 className="text-3xl font-bold">Bank Sampah SMAN 2 Trenggalek</h1>
                    <p className="text-green-100 mt-2">Powered by: Adiwiyata Bakti Mandala</p>
                  </div>
                  <button
                    onClick={() => setDarkMode(!darkMode)}
                    className="p-2 rounded-lg bg-green-700 hover:bg-green-800"
                  >
                    {darkMode ? <Sun size={24} /> : <Moon size={24} />}
                  </button>
                </div>
              </div>

              <div className={bgClass + ' shadow-md'}>
                <div className="max-w-7xl mx-auto px-4">
                  <div className="flex flex-wrap gap-2">
                    {[
                      { id: 'input', label: 'Input Data', icon: Plus },
                      { id: 'rekap', label: 'Rekap & Ringkasan', icon: BarChart3 },
                      { id: 'kupon', label: 'Manajemen Kupon', icon: Ticket },
                      { id: 'pengaturan', label: 'Pengaturan', icon: Settings }
                    ].map(tab => (
                      <button
                        key={tab.id}
                        onClick={() => setActiveTab(tab.id)}
                        className={`flex items-center space-x-2 px-4 py-3 font-medium transition-colors ${
                          activeTab === tab.id
                            ? 'bg-green-600 text-white border-b-4 border-green-700'
                            : darkMode ? 'text-gray-300 hover:bg-gray-700' : 'text-gray-600 hover:bg-gray-100'
                        }`}
                      >
                        <tab.icon size={18} />
                        <span className="hidden sm:inline">{tab.label}</span>
                      </button>
                    ))}
                  </div>
                </div>
              </div>

              <div className="max-w-7xl mx-auto p-4 sm:p-6">
                {activeTab === 'input' && (
                  <div className={`${bgClass} rounded-lg shadow-lg p-4 sm:p-6 ${textClass}`}>
                    <h2 className="text-2xl font-bold mb-4">Pencatatan Sampah Masuk</h2>
                    
                    <div className={`${darkMode ? 'bg-blue-900' : 'bg-blue-50'} border-l-4 border-blue-400 p-4 mb-6`}>
                      <p className="text-sm">
                        <strong>Info:</strong> Gunakan form ini untuk mencatat sampah yang masuk per kelas. 
                        {modePisahJenis ? ' Aktifkan toggle jenis sampah yang sesuai.' : ' Mode akumulasi: semua jenis dihitung sama.'}
                      </p>
                    </div>

                    <div className="flex items-center space-x-3 mb-6">
                      <span className="text-sm font-medium">Mode Input:</span>
                      <button
                        onClick={() => setModePisahJenis(!modePisahJenis)}
                        className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${
                          modePisahJenis ? 'bg-green-600' : 'bg-blue-600'
                        }`}
                      >
                        <span className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${
                          modePisahJenis ? 'translate-x-6' : 'translate-x-1'
                        }`} />
                      </button>
                      <span className="text-sm font-medium">
                        {modePisahJenis ? 'Pisah Jenis' : 'Akumulasi'}
                      </span>
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                      <div>
                        <label className="block text-sm font-medium mb-2">Kelas</label>
                        <select
                          name="kelas"
                          value={formData.kelas}
                          onChange={handleInputChange}
                          className={`w-full p-3 border ${borderClass} rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-white'}`}
                        >
                          {kelasOptions.map(k => <option key={k} value={k}>{k}</option>)}
                        </select>
                      </div>

                      <div>
                        <label className="block text-sm font-medium mb-2">Nama Koordinator (Penyetor)</label>
                        <input
                          type="text"
                          name="koordinator"
                          value={formData.koordinator}
                          onChange={handleInputChange}
                          placeholder="Nama koordinator kelas"
                          className={`w-full p-3 border ${borderClass} rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-white'}`}
                        />
                      </div>

                      {!modePisahJenis && (
                        <div>
                          <label className="block text-sm font-medium mb-2">Berat Total (kg)</label>
                          <input
                            type="number"
                            id="beratAkumulasi"
                            step="0.1"
                            min="0"
                            placeholder="5.5"
                            className={`w-full p-3 border ${borderClass} rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-white'}`}
                          />
                        </div>
                      )}

                      <div>
                        <label className="block text-sm font-medium mb-2">Nama Petugas</label>
                        <input
                          type="text"
                          name="petugas"
                          value={formData.petugas}
                          onChange={handleInputChange}
                          placeholder="Petugas pencatat"
                          className={`w-full p-3 border ${borderClass} rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-white'}`}
                        />
                      </div>

                      <div className="md:col-span-2">
                        <label className="block text-sm font-medium mb-2">Catatan</label>
                        <textarea
                          name="catatan"
                          value={formData.catatan || ''}
                          onChange={handleInputChange}
                          placeholder="Catatan tambahan untuk koordinator..."
                          rows="3"
                          className={`w-full p-3 border ${borderClass} rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-white'}`}
                        />
                      </div>
                    </div>

                    {modePisahJenis && (
                      <div className="mb-6">
                        <label className="block text-sm font-medium mb-3">Pilih Jenis Sampah & Input Berat</label>
                        <div className="space-y-3">
                          {wasteTypes.map(type => (
                            <div key={type} className={`p-4 rounded-lg border-2 transition-all ${
                              selectedWasteTypes[type]
                                ? 'border-green-600 bg-green-50 dark:bg-green-900'
                                : `${borderClass} ${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`
                            }`}>
                              <div className="flex items-center justify-between mb-2">
                                <button
                                  onClick={() => toggleWasteType(type)}
                                  className="flex items-center space-x-2"
                                >
                                  <div className={`w-5 h-5 rounded border-2 flex items-center justify-center ${
                                    selectedWasteTypes[type] ? 'bg-green-600 border-green-600' : 'border-gray-400'
                                  }`}>
                                    {selectedWasteTypes[type] && (
                                      <svg className="w-3 h-3 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" />
                                      </svg>
                                    )}
                                  </div>
                                  <span className="font-medium">{type}</span>
                                </button>
                                <span className="text-sm opacity-75">
                                  Rp {(priceSettings[type] || 2000).toLocaleString('id-ID')}/kg
                                </span>
                              </div>
                              
                              {selectedWasteTypes[type] && (
                                <div className="mt-3 flex items-center space-x-3">
                                  <label className="text-sm font-medium">Berat:</label>
                                  <input
                                    type="number"
                                    value={beratPerJenis[type] || ''}
                                    onChange={(e) => handleBeratJenisChange(type, e.target.value)}
                                    step="0.1"
                                    min="0"
                                    placeholder="0.0"
                                    className={`w-32 p-2 border ${borderClass} rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-white'}`}
                                  />
                                  <span className="text-sm">kg</span>
                                  {beratPerJenis[type] > 0 && (
                                    <span className="text-sm font-medium text-green-600">
                                      = Rp {((beratPerJenis[type] || 0) * (priceSettings[type] || 2000)).toLocaleString('id-ID')}
                                    </span>
                                  )}
                                </div>
                              )}
                            </div>
                          ))}
                        </div>
                        
                        {Object.values(beratPerJenis).some(b => b > 0) && (
                          <div className={`mt-4 p-4 rounded-lg ${darkMode ? 'bg-blue-900' : 'bg-blue-50'} border-l-4 border-blue-500`}>
                            <div className="space-y-1">
                              <div className="flex justify-between items-center">
                                <span className="font-medium">Total Berat:</span>
                                <span className="text-lg font-bold text-blue-600">
                                  {Object.values(beratPerJenis).reduce((a, b) => a + b, 0).toFixed(2)} kg
                                </span>
                              </div>
                              <div className="flex justify-between items-center">
                                <span className="font-medium">Total Nilai:</span>
                                <span className="text-lg font-bold text-blue-600">
                                  Rp {Object.entries(beratPerJenis)
                                    .reduce((sum, [type, berat]) => sum + (berat * (priceSettings[type] || 2000)), 0)
                                    .toLocaleString('id-ID')}
                                </span>
                              </div>
                              <div className="flex justify-between items-center text-sm">
                                <span className="font-medium">Kupon akan Diterbitkan:</span>
                                <span className="font-bold text-green-600">
                                  {Math.floor(Object.values(beratPerJenis).reduce((a, b) => a + b, 0) / beratPerKupon)} kupon
                                </span>
                              </div>
                            </div>
                          </div>
                        )}
                      </div>
                    )}

                    {(modePisahJenis ? Object.values(beratPerJenis).some(b => b > 0) : document.getElementById('beratAkumulasi')?.value > 0) && getJumlahKupon() > 0 && (
                      <div className="mb-6">
                        <div className="flex items-center justify-between mb-3">
                          <label className="block text-sm font-medium">
                            Input Nomor Kupon ({getJumlahKupon()} kupon)
                          </label>
                          <button
                            onClick={toggleKuponInput}
                            className="text-sm text-blue-600 hover:text-blue-800 font-medium"
                          >
                            {showKuponInput ? 'â–¼ Sembunyikan' : 'â–¶ Tampilkan Input Kupon'}
                          </button>
                        </div>
                        
                        {showKuponInput && (
                          <div className={`p-4 rounded-lg border ${borderClass} ${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                            <p className="text-xs mb-3 opacity-75">
                              Isi nomor kupon untuk setiap kupon yang akan diterbitkan (opsional). Kosongkan jika tidak ingin memberi nomor.
                            </p>
                            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">
                              {Array.from({ length: getJumlahKupon() }).map((_, index) => (
                                <div key={index}>
                                  <label className="block text-xs font-medium mb-1">Kupon #{index + 1}</label>
                                  <input
                                    type="text"
                                    value={nomorKuponList[index] || ''}
                                    onChange={(e) => handleNomorKuponChange(index, e.target.value)}
                                    placeholder={`${String(index + 1).padStart(3, '0')}`}
                                    className={`w-full p-2 text-sm border ${borderClass} rounded ${darkMode ? 'bg-gray-600' : 'bg-white'}`}
                                  />
                                </div>
                              ))}
                            </div>
                            <div className="mt-3 text-xs opacity-75">
                              <strong>Tips:</strong> Gunakan penomoran berurutan seperti 001, 002, 003... atau format custom seperti A001, B001, dll.
                            </div>
                          </div>
                        )}
                      </div>
                    )}

                    <button
                      onClick={handleSubmit}
                      className="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition-colors font-medium flex items-center justify-center space-x-2"
                    >
                      <Plus size={20} />
                      <span>Tambah Data</span>
                    </button>

                    {filteredTransactions.length > 0 && (
                      <div className="mt-8">
                        <h3 className="text-xl font-bold mb-4">Data Terbaru</h3>
                        <div className="overflow-x-auto">
                          <table className="w-full border-collapse text-sm">
                            <thead>
                              <tr className={darkMode ? 'bg-gray-700' : 'bg-gray-100'}>
                                <th className={`border ${borderClass} p-2 text-left min-w-[120px]`}>ID Setoran</th>
                                <th className={`border ${borderClass} p-2 text-left min-w-[140px]`}>Tanggal</th>
                                <th className={`border ${borderClass} p-2 text-left min-w-[60px]`}>Kelas</th>
                                <th className={`border ${borderClass} p-2 text-left min-w-[100px]`}>Koordinator</th>
                                <th className={`border ${borderClass} p-2 text-left min-w-[80px]`}>Jenis</th>
                                <th className={`border ${borderClass} p-2 text-right min-w-[70px]`}>Berat</th>
                                <th className={`border ${borderClass} p-2 text-right min-w-[100px]`}>Total</th>
                                <th className={`border ${borderClass} p-2 text-left min-w-[120px]`}>Catatan</th>
                                <th className={`border ${borderClass} p-2 min-w-[60px]`}>Aksi</th>
                              </tr>
                            </thead>
                            <tbody>
                              {filteredTransactions.slice(0, 10).map(t => (
                                <tr key={t.id} className={darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-50'}>
                                  <td className={`border ${borderClass} p-2 text-xs font-mono`}>
                                    {t.setoranId?.substring(0, 20)}...
                                  </td>
                                  <td className={`border ${borderClass} p-2 text-xs`}>
                                    {new Date(t.tanggal).toLocaleString('id-ID')}
                                  </td>
                                  <td className={`border ${borderClass} p-2`}>{t.kelas}</td>
                                  <td className={`border ${borderClass} p-2`}>{t.koordinator}</td>
                                  <td className={`border ${borderClass} p-2`}>{t.jenisSampah}</td>
                                  <td className={`border ${borderClass} p-2 text-right`}>{t.berat.toFixed(2)} kg</td>
                                  <td className={`border ${borderClass} p-2 text-right`}>Rp {t.totalHarga.toLocaleString('id-ID')}</td>
                                  <td className={`border ${borderClass} p-2 text-xs max-w-xs truncate`} title={t.catatan}>
                                    {t.catatan || '-'}
                                  </td>
                                  <td className={`border ${borderClass} p-2 text-center`}>
                                    <button onClick={() => handleDeleteTransaction(t.id)} className="text-red-600 hover:text-red-800">
                                      <Trash2 size={16} />
                                    </button>
                                  </td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {activeTab === 'rekap' && (
                  <div className="space-y-6">
                    <div className={`${bgClass} rounded-lg shadow-lg p-4 sm:p-6 ${textClass}`}>
                      <div className={`${darkMode ? 'bg-blue-900' : 'bg-blue-50'} border-l-4 border-blue-400 p-4 mb-6`}>
                        <p className="text-sm">
                          <strong>Info:</strong> Lihat ringkasan data sampah yang masuk dengan filter periode. Data chart dan tabel mengikuti periode yang dipilih.
                        </p>
                      </div>

                      <div className="flex flex-wrap gap-4 mb-6">
                        <div>
                          <label className="block text-sm font-medium mb-2">Filter Periode</label>
                          <select
                            value={filterPeriod}
                            onChange={(e) => setFilterPeriod(e.target.value)}
                            className={`p-3 border ${borderClass} rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-white'}`}
                          >
                            <option value="all">Semua Data</option>
                            <option value="today">Hari Ini</option>
                            <option value="week">7 Hari Terakhir</option>
                            <option value="month">Bulan Ini</option>
                            <option value="custom">Kustom</option>
                          </select>
                        </div>

                        {filterPeriod === 'custom' && (
                          <>
                            <div>
                              <label className="block text-sm font-medium mb-2">Dari Tanggal</label>
                              <input
                                type="date"
                                value={customDateStart}
                                onChange={(e) => setCustomDateStart(e.target.value)}
                                className={`p-3 border ${borderClass} rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-white'}`}
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium mb-2">Sampai Tanggal</label>
                              <input
                                type="date"
                                value={customDateEnd}
                                onChange={(e) => setCustomDateEnd(e.target.value)}
                                className={`p-3 border ${borderClass} rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-white'}`}
                              />
                            </div>
                          </>
                        )}

                        <div className="flex items-end">
                          <button
                            onClick={exportToCSV}
                            className="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 flex items-center space-x-2"
                          >
                            <Download size={20} />
                            <span>Ekspor CSV</span>
                          </button>
                        </div>
                      </div>

                      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div className="bg-gradient-to-br from-green-500 to-green-600 text-white rounded-lg p-4">
                          <h3 className="text-sm font-medium mb-2">Total Berat</h3>
                          <p className="text-3xl font-bold">{summary.totalBerat.toFixed(2)} kg</p>
                          <p className="text-green-100 text-xs mt-1">{filteredTransactions.length} transaksi</p>
                        </div>
                        
                        <div className="bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-lg p-4">
                          <h3 className="text-sm font-medium mb-2">Total Nilai</h3>
                          <p className="text-3xl font-bold">Rp {summary.totalNilai.toLocaleString('id-ID')}</p>
                        </div>

                        <div className="bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-lg p-4">
                          <h3 className="text-sm font-medium mb-2">Jenis Terbanyak</h3>
                          <p className="text-xl font-bold">
                            {summary.jenisTerbanyak ? summary.jenisTerbanyak[0] : '-'}
                          </p>
                          <p className="text-purple-100 text-xs mt-1">
                            {summary.jenisTerbanyak ? `${summary.jenisTerbanyak[1].berat.toFixed(2)} kg` : ''}
                          </p>
                        </div>

                        <div className="bg-gradient-to-br from-yellow-500 to-yellow-600 text-white rounded-lg p-4">
                          <h3 className="text-sm font-medium mb-2">Kupon Tersedia</h3>
                          <p className="text-3xl font-bold">{kuponSisa}</p>
                          <p className="text-yellow-100 text-xs mt-1">dari {totalKupon} kupon</p>
                        </div>
                      </div>

                      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div className={`${bgClass} p-4 rounded-lg border ${borderClass}`}>
                          <h3 className="text-lg font-bold mb-4">Rekap Per Kelas</h3>
                          <div className="overflow-x-auto">
                            <table className="w-full text-sm">
                              <thead>
                                <tr className={darkMode ? 'bg-gray-700' : 'bg-gray-100'}>
                                  <th className={`border ${borderClass} p-2 text-left`}>Kelas</th>
                                  <th className={`border ${borderClass} p-2 text-right`}>Berat</th>
                                  <th className={`border ${borderClass} p-2 text-right`}>Nilai</th>
                                </tr>
                              </thead>
                              <tbody>
                                {Object.entries(summary.perKelas)
                                  .sort(([a], [b]) => a.localeCompare(b))
                                  .map(([kelas, data]) => (
                                    <tr key={kelas}>
                                      <td className={`border ${borderClass} p-2`}>{kelas}</td>
                                      <td className={`border ${borderClass} p-2 text-right`}>{data.berat.toFixed(2)} kg</td>
                                      <td className={`border ${borderClass} p-2 text-right`}>Rp {data.nilai.toLocaleString('id-ID')}</td>
                                    </tr>
                                  ))}
                              </tbody>
                            </table>
                          </div>
                        </div>

                        <div className={`${bgClass} p-4 rounded-lg border ${borderClass}`}>
                          <h3 className="text-lg font-bold mb-4">Rekap Per Jenis</h3>
                          <div className="overflow-x-auto">
                            <table className="w-full text-sm">
                              <thead>
                                <tr className={darkMode ? 'bg-gray-700' : 'bg-gray-100'}>
                                  <th className={`border ${borderClass} p-2 text-left`}>Jenis</th>
                                  <th className={`border ${borderClass} p-2 text-right`}>Berat</th>
                                  <th className={`border ${borderClass} p-2 text-right`}>Nilai</th>
                                </tr>
                              </thead>
                              <tbody>
                                {Object.entries(summary.perJenis).map(([jenis, data]) => (
                                  <tr key={jenis}>
                                    <td className={`border ${borderClass} p-2`}>{jenis}</td>
                                    <td className={`border ${borderClass} p-2 text-right`}>{data.berat.toFixed(2)} kg</td>
                                    <td className={`border ${borderClass} p-2 text-right`}>Rp {data.nilai.toLocaleString('id-ID')}</td>
                                  </tr>
                                ))}
                              </tbody>
                            </table>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                {activeTab === 'kupon' && (
                  <div className={`${bgClass} rounded-lg shadow-lg p-4 sm:p-6 ${textClass}`}>
                    <h2 className="text-2xl font-bold mb-4">Manajemen Kupon</h2>
                    
                    <div className={`${darkMode ? 'bg-blue-900' : 'bg-blue-50'} border-l-4 border-blue-400 p-4 mb-6`}>
                      <p className="text-sm">
                        <strong>Info:</strong> Kupon dihitung otomatis dari total berat. Setiap {beratPerKupon} kg = 1 kupon. 
                        {modePisahJenis ? ' Input berat per jenis sampah yang dipilih.' : ' Input berat total untuk mode akumulasi.'}
                      </p>
                    </div>

                    <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                      <div className={`p-4 rounded-lg border ${borderClass}`}>
                        <h3 className="text-sm font-medium mb-2">Total Diterbitkan</h3>
                        <p className="text-3xl font-bold text-green-600">{totalKupon}</p>
                      </div>
                      <div className={`p-4 rounded-lg border ${borderClass}`}>
                        <h3 className="text-sm font-medium mb-2">Sudah Digunakan</h3>
                        <p className="text-3xl font-bold text-blue-600">{kuponDigunakan}</p>
                      </div>
                      <div className={`p-4 rounded-lg border ${borderClass}`}>
                        <h3 className="text-sm font-medium mb-2">Tersisa</h3>
                        <p className="text-3xl font-bold text-purple-600">{kuponSisa}</p>
                      </div>
                    </div>

                    <button
                      onClick={useCoupon}
                      className="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 mb-6"
                    >
                      Gunakan Kupon
                    </button>

                    <div className="mb-6">
                      <h3 className="text-lg font-bold mb-3">Kupon Per Kelas</h3>
                      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                        {Object.entries(kuponPerKelas).map(([kelas, data]) => (
                          <div key={kelas} className={`p-3 rounded-lg border ${borderClass}`}>
                            <div className="font-bold text-lg">{kelas}</div>
                            <div className="text-sm mt-1">
                              <span className="text-green-600">âœ“ {data.tersedia} Tersedia</span>
                              {' | '}
                              <span className="text-red-600">âœ— {data.digunakan} Digunakan</span>
                            </div>
                            <div className="text-xs opacity-75 mt-1">Total: {data.total} kupon</div>
                          </div>
                        ))}
                      </div>
                    </div>

                    <div className="flex items-center justify-between mb-4">
                      <h3 className="text-lg font-bold">Daftar Kupon</h3>
                      <div className="flex items-center space-x-2">
                        <button
                          onClick={() => setKuponPage(Math.max(0, kuponPage - 1))}
                          disabled={kuponPage === 0}
                          className={`p-2 rounded ${kuponPage === 0 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-200 dark:hover:bg-gray-700'}`}
                        >
                          â†
                        </button>
                        <span className="text-sm">
                          {kuponPage * KUPON_PER_PAGE + 1} - {Math.min((kuponPage + 1) * KUPON_PER_PAGE, coupons.length)} dari {coupons.length}
                        </span>
                        <button
                          onClick={() => setKuponPage(Math.min(totalKuponPages - 1, kuponPage + 1))}
                          disabled={kuponPage >= totalKuponPages - 1}
                          className={`p-2 rounded ${kuponPage >= totalKuponPages - 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-200 dark:hover:bg-gray-700'}`}
                        >
                          â†’
                        </button>
                      </div>
                    </div>

                    <div className="overflow-x-auto">
                      <table className="w-full text-sm">
                        <thead>
                          <tr className={darkMode ? 'bg-gray-700' : 'bg-gray-100'}>
                            <th className={`border ${borderClass} p-2 text-left min-w-[180px]`}>Nomor Kupon</th>
                            <th className={`border ${borderClass} p-2 text-left min-w-[120px]`}>ID Setoran</th>
                            <th className={`border ${borderClass} p-2 text-left min-w-[60px]`}>Kelas</th>
                            <th className={`border ${borderClass} p-2 text-left min-w-[100px]`}>Koordinator</th>
                            <th className={`border ${borderClass} p-2 text-right min-w-[100px]`}>Berat Total</th>
                            <th className={`border ${borderClass} p-2 text-center min-w-[80px]`}>Urutan</th>
                            <th className={`border ${borderClass} p-2 text-left min-w-[140px]`}>Tanggal</th>
                            <th className={`border ${borderClass} p-2 text-left min-w-[80px]`}>Status</th>
                            <th className={`border ${borderClass} p-2 text-center min-w-[120px]`}>Aksi</th>
                          </tr>
                        </thead>
                        <tbody>
                          {paginatedCoupons.map((c) => (
                            <tr key={c.id}>
                              <td className={`border ${borderClass} p-2`}>
                                {editingKupon === c.id ? (
                                  <input
                                    type="text"
                                    value={editNomorValue}
                                    onChange={(e) => setEditNomorValue(e.target.value)}
                                    className={`w-full p-1 text-xs border rounded ${darkMode ? 'bg-gray-700' : 'bg-white'}`}
                                  />
                                ) : (
                                  <span className={`font-mono text-xs ${c.nomor.startsWith('BSDA-RNDM') ? 'text-blue-600' : 'text-green-600'} font-bold`}>
                                    {c.nomor}
                                  </span>
                                )}
                              </td>
                              <td className={`border ${borderClass} p-2 text-xs font-mono`}>
                                {c.setoranId?.substring(0, 15)}...
                              </td>
                              <td className={`border ${borderClass} p-2`}>{c.kelas}</td>
                              <td className={`border ${borderClass} p-2`}>{c.koordinator}</td>
                              <td className={`border ${borderClass} p-2 text-right`}>
                                {c.berat.toFixed(2)} kg
                                <span className="text-xs opacity-75 block">({c.jumlahTotal} kupon)</span>
                              </td>
                              <td className={`border ${borderClass} p-2 text-center`}>
                                #{c.urutanKe} / {c.jumlahTotal}
                              </td>
                              <td className={`border ${borderClass} p-2 text-xs`}>
                                {new Date(c.tanggal).toLocaleString('id-ID')}
                              </td>
                              <td className={`border ${borderClass} p-2`}>
                                <span className={`px-2 py-1 rounded text-xs ${
                                  c.digunakan ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'
                                }`}>
                                  {c.digunakan ? 'Digunakan' : 'Tersedia'}
                                </span>
                              </td>
                              <td className={`border ${borderClass} p-2 text-center`}>
                                {editingKupon === c.id ? (
                                  <div className="flex gap-1 justify-center">
                                    <button
                                      onClick={handleSaveEditKupon}
                                      className="text-green-600 hover:text-green-800 p-1"
                                      title="Simpan"
                                    >
                                      <Save size={16} />
                                    </button>
                                    <button
                                      onClick={handleCancelEditKupon}
                                      className="text-gray-600 hover:text-gray-800 p-1"
                                      title="Batal"
                                    >
                                      âœ•
                                    </button>
                                  </div>
                                ) : (
                                  <div className="flex gap-1 justify-center">
                                    <button
                                      onClick={() => handleEditKupon(c)}
                                      className="text-blue-600 hover:text-blue-800 p-1"
                                      title="Edit"
                                    >
                                      âœŽ
                                    </button>
                                    <button
                                      onClick={() => handleDeleteKupon(c.id)}
                                      className="text-red-600 hover:text-red-800 p-1"
                                      title="Hapus"
                                    >
                                      <Trash2 size={16} />
                                    </button>
                                  </div>
                                )}
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}

                {activeTab === 'pengaturan' && (
                  <div className={`${bgClass} rounded-lg shadow-lg p-4 sm:p-6 ${textClass}`}>
                    <h2 className="text-2xl font-bold mb-4">Pengaturan Aplikasi</h2>

                    <div className={`${darkMode ? 'bg-yellow-900' : 'bg-yellow-50'} border-l-4 border-yellow-400 p-4 mb-6`}>
                      <p className="text-sm">
                        <strong>Info:</strong> Kelola jenis sampah, harga, kupon, dan konfigurasi aplikasi di sini.
                      </p>
                    </div>

                    <div className="space-y-6">
                      <div className={`p-4 rounded-lg border ${borderClass}`}>
                        <h3 className="font-bold mb-4">Jenis Sampah</h3>
                        <div className="space-y-3">
                          {wasteTypes.map(type => (
                            <div key={type} className="flex items-center justify-between">
                              <div className="flex-1">
                                <span className="font-medium">{type}</span>
                                <div className="flex items-center space-x-3 mt-2">
                                  <span className="text-sm">Harga:</span>
                                  <input
                                    type="number"
                                    value={priceSettings[type] || 0}
                                    onChange={(e) => setPriceSettings(prev => ({
                                      ...prev,
                                      [type]: parseFloat(e.target.value) || 0
                                    }))}
                                    className={`w-32 p-2 border ${borderClass} rounded ${darkMode ? 'bg-gray-700' : 'bg-white'}`}
                                  />
                                  <span className="text-sm">/kg</span>
                                </div>
                              </div>
                              <button
                                onClick={() => deleteWasteType(type)}
                                className="text-red-600 hover:text-red-800 p-2"
                              >
                                <Trash2 size={18} />
                              </button>
                            </div>
                          ))}
                        </div>
                        <button
                          onClick={addWasteType}
                          className="mt-4 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 flex items-center space-x-2"
                        >
                          <Plus size={18} />
                          <span>Tambah Jenis Sampah</span>
                        </button>
                      </div>

                      <div className={`p-4 rounded-lg border ${borderClass}`}>
                        <h3 className="font-bold mb-4">Harga Mode Akumulasi</h3>
                        <div className="flex items-center space-x-3">
                          <span>Rp</span>
                          <input
                            type="number"
                            value={hargaAkumulasi}
                            onChange={(e) => setHargaAkumulasi(parseFloat(e.target.value) || 0)}
                            className={`w-40 p-2 border ${borderClass} rounded ${darkMode ? 'bg-gray-700' : 'bg-white'}`}
                          />
                          <span>/kg</span>
                        </div>
                      </div>

                      <div className={`p-4 rounded-lg border ${borderClass}`}>
                        <h3 className="font-bold mb-4">Berat Per Kupon</h3>
                        <p className="text-sm mb-3 opacity-75">
                          <em>Info: Nomor kupon diinput manual oleh petugas, tidak digenerate otomatis.</em>
                        </p>
                        <div className="flex items-center space-x-3">
                          <input
                            type="number"
                            value={beratPerKupon}
                            onChange={(e) => setBeratPerKupon(parseFloat(e.target.value) || 0.5)}
                            step="0.1"
                            min="0.1"
                            className={`w-32 p-2 border ${borderClass} rounded ${darkMode ? 'bg-gray-700' : 'bg-white'}`}
                          />
                          <span>kg = 1 kupon (referensi)</span>
                        </div>
                      </div>

                      <div className={`p-4 rounded-lg border ${borderClass}`}>
                        <h3 className="font-bold mb-4">Manajemen Data</h3>
                        <div className="space-y-3">
                          <div>
                            <p className="text-sm mb-2 opacity-75">Ekspor & Impor Semua Data (Transaksi, Kupon, Pengaturan)</p>
                            <div className="flex flex-wrap gap-2">
                              <button
                                onClick={exportAllData}
                                className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center space-x-2"
                              >
                                <Download size={18} />
                                <span>Ekspor Backup Lengkap</span>
                              </button>
                              <label className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 flex items-center space-x-2 cursor-pointer">
                                <Upload size={18} />
                                <span>Impor Backup</span>
                                <input
                                  type="file"
                                  accept=".json"
                                  onChange={importAllData}
                                  className="hidden"
                                />
                              </label>
                            </div>
                          </div>

                          <div className="border-t pt-3">
                            <p className="text-sm mb-2 opacity-75">Ekspor & Impor Konfigurasi Saja (Tanpa Data Transaksi)</p>
                            <div className="flex flex-wrap gap-2">
                              <button
                                onClick={exportConfig}
                                className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 flex items-center space-x-2"
                              >
                                <Download size={18} />
                                <span>Ekspor Konfigurasi</span>
                              </button>
                              <label className="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 flex items-center space-x-2 cursor-pointer">
                                <Upload size={18} />
                                <span>Impor Konfigurasi</span>
                                <input
                                  type="file"
                                  accept=".json,.txt"
                                  onChange={importConfig}
                                  className="hidden"
                                />
                              </label>
                            </div>
                          </div>

                          <div className="border-t pt-3">
                            <p className="text-sm mb-2 opacity-75 text-red-600 font-medium">
                              âš ï¸ Zona Bahaya: Reset Sistem
                            </p>
                            <button
                              onClick={resetAllData}
                              className="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 flex items-center space-x-2"
                            >
                              <Trash2 size={18} />
                              <span>Hapus Semua Data & Reset</span>
                            </button>
                            <p className="text-xs mt-2 opacity-75">
                              Menghapus semua transaksi, kupon, dan mengembalikan pengaturan ke default. 
                              Data tidak dapat dikembalikan!
                            </p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                )}
              </div>

              <div className="bg-gray-800 text-white p-6 mt-12">
                <p className="text-center text-sm">
                  Â© {new Date().getFullYear()} Bank Sampah SMAN 2 Trenggalek - Adiwiyata Bakti Mandala
                </p>
              </div>
            </div>
          );
        };
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<BankSampahApp />);
    </script>
</body>
</html>